---
format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: other

workflows:

### MARK: Basic Workflows
  # Ensure unit tests are passing
  Prepare_environment:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@6: {}
  
  Run_unit_tests:
    steps:
    - script@1:
        title: Run unit tests
        inputs:
        - content: |-
            xcodebuild test \
                -sdk iphonesimulator \
                -destination "platform=iOS Simulator,name=iPhone 14" \
                -scheme "CheckoutNetwork" \
                | xcpretty \
                && exit ${PIPESTATUS[0]}

  Run_sonar:
    steps:
    - script@1:
        title: Install and run SonarQube
        inputs:
        - content: |-
            chmod 755 ./Scripts/runSonarQube.sh
            ./Scripts/runSonarQube.sh
            
### MARK: Merged Workflows
  UnitTestPipeline:
    before_run:
    - Prepare_environment
    after_run:
    - Run_unit_tests
    
  SonarQubePipeline:
    before_run:
    - Prepare_environment
    after_run:
    - Run_sonar
    
meta:
  bitrise.io:
    stack: osx-xcode-14.3.x-ventura
    machine_type_id: g2-m1.4core
    
### MARK: Automatic triggers
# Only the first trigger is detected, so the order is very important !!!
trigger_map:
  # On each pull request run unit tests
- pull_request_source_branch: '*'
  pull_request_target_branch: '*'
  workflow: UnitTestPipeline
